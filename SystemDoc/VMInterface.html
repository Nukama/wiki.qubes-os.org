<h1 id="VMConfigurationInterface">VM Configuration Interface</h1>
<p>Qubes VM have some settings set by dom0 based on VM settings. There are multiple configuration channels, which includes:</p>
<ul>
<li>XenStore</li>
<li>QubesDB - replacing most of xenstore (in R3 only)</li>
<li>Qubes RPC (called at VM startup, or when configuration changed)</li>
<li>GUI protocol</li>
</ul>
<h2 id="xenstore">xenstore</h2>
<p>Keys exposed by dom0 to VM (only Qubes specific included):</p>
<ul>
<li><code>qubes-vm-type</code> - VM type, the same as <code>type</code> field in <code>qvm-prefs</code>. One of <code>AppVM</code>, <code>ProxyVM</code>, <code>NetVM</code>, <code>TemplateVM</code>, <code>HVM</code>, <code>TemplateHVM</code></li>
<li><code>qubes-vm-updatable</code> - flag whether VM is updatable (whether changes in root.img will survive VM restart). One of <code>True</code>, <code>False</code></li>
<li><code>qubes-timezone - name of timezone based on dom0 timezone. For example </code><a href="/wiki/wiki/SystemDoc/Europe/Warsaw">Europe/Warsaw?</a>`</li>
<li><code>qubes-keyboard</code> - keyboard layout based on dom0 layout. Its syntax is suitable for <code>xkbcomp</code> command (after expanding escape sequences like <code>\n</code> or <code>\t</code>). This is meant only as some default value, VM can ignore this option and choose its own keyboard layout (this is what keyboard setting from Qubes Manager does). This entry is created as part of gui-daemon initialization (so not available when gui-daemon disabled, or not started yet).</li>
<li><code>qubes-debug-mode</code> - flag whether VM have debug mode enabled (qvm-prefs setting). One of <code>1</code>, <code>0</code></li>
<li><code>qubes-service/SERVICE_NAME</code> - subtree for VM services controlled from dom0 (using qvm-service command or Qubes Manager). One of <code>1</code>, <code>0</code>. Note that not every service will be listed here, if entry is missing, it means &quot;use VM default&quot;. List of currently supported services is in <a href="/wiki/wiki/Dom0Tools/QvmService">qvm-service man page</a></li>
<li><code>qubes-netmask</code> - network mask (only when VM has netvm set); currently hardcoded &quot;255.255.255.0&quot;</li>
<li>`qubes-ip - IP address for this VM (only when VM has netvm set)</li>
<li><code>qubes-gateway</code> - default gateway IP and primary DNS address (only when VM has netvm set); VM should add host route to this address directly via eth0 (or whatever default interface name is)</li>
<li><code>qubes-secondary-dns</code> - secondary DNS address (only when VM has netvm set)</li>
<li><code>qubes-netvm-gateway</code> - same as <code>qubes-gateway</code> in connected VMs (only when VM serves as network backend - ProxyVM and NetVM); because this is also set as primary DNS in connected VMs, traffic sent to this IP on port 53 should be redirected to DNS server</li>
<li><code>qubes-netvm-netmask</code> - same as <code>qubes-netmask</code> in connected VMs (only when VM serves as network backend - ProxyVM and NetVM)</li>
<li><code>qubes-netvm-network</code> - network address (only when VM serves as network backend - ProxyVM and NetVM); can be also calculated from qubes-netvm-gateway and qubes-netvm-netmask</li>
<li><code>qubes-netvm-secondary-dns</code> - same as <code>qubes-secondary-dns</code> in connected VMs (only when VM serves as network backend - ProxyVM and NetVM); traffic sent to this IP on port 53 should be redirected to secondary DNS server</li>
</ul>
<p>Keys set by VM for passing info to dom0:</p>
<ul>
<li><code>memory/meminfo</code> - used memory (updated by qubes-meminfo-writer), input information for qmemman; Format: 6 lines (EOL encoded as <code>\n</code>), each in format &quot;FIELD: VALUE kB&quot;; fields: <code>MemTotal</code>, <code>MemFree</code>, <code>Buffers</code>, <code>Cached</code>, <code>SwapTotal</code>, <code>SwapFree</code>; meaning the same as in <code>/proc/meminfo</code> in Linux</li>
<li><code>qubes-block-devices</code> - list of block devices exposed by this VM, each device (subdirectory) should be named in a way that VM can attach the device based on it. Each should contain those entries:
<ul>
<li><code>desc</code> - device description (ASCII text)</li>
<li><code>size</code> - device size in bytes</li>
<li><code>mode</code> - default connection mode; <code>r</code> for read-only, <code>w</code> for read-write</li>
</ul></li>
<li><code>qubes-usb-devices</code> - list of USB devices exposed by this VM, each device (subdirectory) should contain:
<ul>
<li><code>desc</code> - device description (ASCII text)</li>
<li><code>usb-ver</code> - USB version (1, 2 or 3)</li>
</ul></li>
</ul>
<h2 id="QubesRPC">Qubes RPC</h2>
<p>Services called by dom0 to provide some VM configuration:</p>
<ul>
<li>qubes.SetMonitorLayout - provide list of monitors, one in a line, each line contains four numbers: width height X Y</li>
<li>qubes.WaitForSession - called to wait for full VM startup</li>
<li>qubes.GetAppmenus - receive appmenus from given VM (template); TODO: describe format here</li>
<li>qubes.GetImageRGBA - receive image/application icon: TODO: describe format and parameters here</li>
</ul>
<h2 id="GUIprotocol">GUI protocol</h2>
<p>GUI initialization includes passing the whole screen dimensions from dom0 to VM. This will most likely be overwritten by qubes.<a href="/wiki/wiki/SystemDoc/SetMonitorLayout">SetMonitorLayout?</a> Qubes RPC call.</p>
