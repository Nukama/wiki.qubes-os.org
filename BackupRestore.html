<h1 id="BackupRestoreMigrationTools">Backup, Restore, Migration Tools</h1>
<p>Qubes supports easy backups and restores of your VMs, and specifically very easy migration between two systems.</p>
<p>There are currently two command-line tools for this: <code>qvm-backup</code> and <code>qvm-backup-restore</code>, both of which are available in Qubes Alpha 2 (qubes-core-dom0 &gt;= 1.1.8). Users of Qubes Alpha 1 can still download the <code>qvm-backup</code> too <a href="http://qubes-os.org/yum/misc/qvm-backup">â€‹here</a> and use it to make a full backup of their system, and later restore it on Qubes Alpha 2, using qvm-backup-restore (the latter is not available on Alpha 1).</p>
<h2 id="MakingafullbackupofyourVMs">Making a full backup of your VMs</h2>
<ol>
<li>Prepare an encrypted external medium to store the backup</li>
</ol>
<p>It is strongly recommended to use encrypted media for the backup. <code>qvm-backup</code> will not encrypt the backup!</p>
<p>Steps to create a fully encrypted LUKS volume on the external USB hard drive /dev/sdb:</p>
<p><strong>WARNING</strong>: Everything on your external USB drive will be deleted with this process!</p>
<pre class="wiki"><code>$ sudo wipefs -a /dev/sdb
$ sudo cryptsetup luksFormat /dev/sdb
$ sudo blkid /dev/sdb
$ sudo cryptsetup open --type luks UUID=the-long-UUID-you-just-got-from-blkid backup
$ sudo mkfs.ext4 -m 0 /dev/mapper/backup</code></pre>
<ol start="2">
<li>Mount the encrypted medium on which the backup will be stored</li>
</ol>
<pre class="wiki"><code>$ sudo mkdir /backup
$ sudo blkid /dev/mapper/backup
$ sudo vi /etc/fstab
(add a line similar to this:
UUID=the-SECOND-long-UUID-you-just-got-for-the-mapper-device /mnt/backup ext4 defaults 1 2
)
$ sudo mount /mnt/backup</code></pre>
<p>Now anything we store in /mnt/backup is stored on the encrypted LUKS volume of our external USB drive.</p>
<ol start="3">
<li>Backup your VMs</li>
</ol>
<pre class="wiki"><code>$ sudo qvm-backup /mnt/backup</code></pre>
<p>The <code>qvm-backup</code> tool will take care about backing up the VMs configuration, and all your AppVMs private storages, and, if necessary, will also backup any custom templates or netvms that any of your AppVMs might be using.</p>
<ol start="4">
<li>Lock the encrypted volume</li>
</ol>
<pre class="wiki"><code>$ sudo umount /mnt/backup
$ sudo cryptsetup close backup</code></pre>
<h2 id="RestoringVMsfromabackup">Restoring VMs from a backup</h2>
<ol>
<li>Mount the media with your backups</li>
</ol>
<pre class="wiki"><code>$ sudo mount /mnt/backup</code></pre>
<ol start="2">
<li>Restore VMs</li>
</ol>
<pre class="wiki"><code>$ sudo qvm-backup-restore /mnt/backup/&lt;specific_backup_dir&gt;</code></pre>
<p>The <code>qvm-backup-restore</code> tool will restore all the VMs (and any backed up custom template VMs), update the Qubes database and add appmenus for the restored VMs. Your existing VMs will not be removed.</p>
<p>If there is a name conflict, i.e. you try restoring a VM with the same name as a VM already on the host, <code>qvm-backup-restore</code> will refuse to continue and will ask you to remove (or rename) the conflicting VM from the host first.</p>
