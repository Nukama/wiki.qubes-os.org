<h1 id="Profiling">Profiling</h1>
<p>This is python profiling primer.</p>
<p>For the purpose of this document, <code>qubes-dev</code> is name of the domain used for postprocessing profiling stats.</p>
<h2 id="Requirements">Requirements</h2>
<pre class="wiki"><code>yum install gprof2dot graphviz
git clone http://git.woju.eu/qubes/profiling.git</code></pre>
<p>If you profile something on dom0, move <code>Upload.sh</code> from repository to dom0:</p>
<pre class="wiki"><code>mkdir -p ~/profiling
qvm-run -p qubes-dev &#39;cat ~/profiling/Upload.sh&#39; &gt; ~/profiling/Upload.sh</code></pre>
<h2 id="Workflow">Workflow</h2>
<h3 id="Identifyfunctionresponsibleforsomeslowaction">Identify function responsible for some slow action</h3>
<p>You have to select area in which you suspect less than optimal performance. If you do not narrow the area, graphs may be unreadable.</p>
<h3 id="Replacesuspectfunctionwithprobe">Replace suspect function with probe</h3>
<p>Replace</p>
<pre><code>def foo(self, bar):
    # function content</code></pre>
<p>with</p>
<pre><code>def foo(self, *args):
    profile.runctx(&#39;self.real_foo(*args)&#39;, globals(), locals(),
        time.strftime(&#39;/home/user/profiling/foo-%Y%m%d-%H%M%S.pstats&#39;))

def real_foo(self, a, b, c):
    # function content</code></pre>
<h3 id="Runapplication">Run application</h3>
<p>Beware that some functions may be called often. For example <code>qubesmanager/main.py:update_table</code> gets run once per second. This will produce one pstat file per second.</p>
<p>Remember to revert your changes to application afterwards.</p>
<h3 id="Uploadstatistics">Upload statistics</h3>
<p>If you are in dom0:</p>
<pre class="wiki"><code>cd ~/profiling
./Upload.sh</code></pre>
<h3 id="Analyse">Analyse</h3>
<pre class="wiki"><code>make</code></pre>
<p>For every <code>${basename}.pstats</code> this will produce <code>${basename}.txt</code> and <code>${basename}.svg</code>. SVG contains call graph. Text file contains list of all functions sorted by cumulative execution time. You may also try <code>make all-png</code>.</p>
<pre class="wiki"><code>make index.html</code></pre>
<p>This creates <code>index.html</code> with all SVG graphics linked to TXT files. Ready for upload.</p>
<pre class="wiki"><code>make REMOTE=example.com:public_html/qubes/profiling/ upload</code></pre>
<h2 id="Example">Example</h2>
<p>This example is from <code>qubes-manager</code> (<code>qubesmanager/main.py</code>).</p>
<p><a href="/wiki/attachment/wiki/Profiling/update_table-20140424-170010.svg"><img src="/wiki/chrome/common/attachment.png" title="No image &quot;update_table-20140424-170010.svg&quot; attached to Profiling" alt="No image &quot;update_table-20140424-170010.svg&quot; attached to Profiling" /></a></p>
<p>It is apparent than problem is around <code>get_disk_usage</code> which calls something via <code>subprocess.call</code>. It does it 15 times, probably once per VM.</p>
