<h1 id="DevelopmentWorkflow">Development Workflow</h1>
<p>A workflow for developing Qubes OS+</p>
<p>First things first, setup <a href="/wiki/wiki/QubesBuilder">QubesBuilder</a>. This guide assumes you're using qubes-builder to build Qubes.</p>
<h2 id="RepositoriesandCommittingCode">Repositories and Committing Code</h2>
<p>Qubes is split into a bunch of git repos. This are all contained in the <code>qubes-src</code> directory under qubes-builder.</p>
<p>The best way to write and contribute code is to create a git repo somewhere (e.g., github) for the repo you are interested in editing (e.g., <code>qubes-manager</code>, <code>core</code>, etc). To integrate your repo with the rest of Qubes, cd to the repo directory and add your repository as a remote in git</p>
<p><strong>Example:</strong></p>
<pre class="wiki"><code>$ cd qubes-builder/qubes-src/qubes-manager
$ git remote add abel git@github.com:abeluck/qubes-manager.git</code></pre>
<p>You can then proceed to easily develop in your own branches, pull in new commits from the dev branches, merge them, and eventually push to your own repo on github.</p>
<p>When you are ready to submit your changes to Qubes to be merged, push your changes, then create a signed git tag (using <code>git tag -s</code>). Finally, send a letter to the Qubes listserv describing the changes and including the link to your repository. Don't forget to include your public PGP key you use to sign your tags.</p>
<h3 id="Kernel-specificnotes">Kernel-specific notes</h3>
<h4 id="PreparefreshversionofkernelsourceswithQubes-specificpatchesapplied">Prepare fresh version of kernel sources, with Qubes-specific patches applied</h4>
<p>In qubes-builder/qubes-src/kernel:</p>
<pre class="wiki"><code>make prep</code></pre>
<p>The resulting tree will be in kernel-&lt;VERSION&gt;/linux-&lt;VERSION&gt;:</p>
<pre class="wiki"><code>ls -ltrd kernel*/linux*</code></pre>
<pre class="wiki"><code>drwxr-xr-x 23 user user 4096 Nov  5 09:50 kernel-3.4.18/linux-3.4.18
drwxr-xr-x  6 user user 4096 Nov 21 20:48 kernel-3.4.18/linux-obj</code></pre>
<h4 id="Gotothekerneltreeandupdatetheversion">Go to the kernel tree and update the version</h4>
<p>In qubes-builder/qubes-src/kernel:</p>
<pre class="wiki"><code>cd kernel-3.4.18/linux-3.4.18</code></pre>
<h4 id="Changingtheconfig">Changing the config</h4>
<p>In kernel-3.4.18/linux-3.4.18:</p>
<pre class="wiki"><code>cp ../../config-pvops .config
make oldconfig</code></pre>
<p>Now change the configuration. For example, in kernel-3.4.18/linux-3.4.18:</p>
<pre class="wiki"><code>make menuconfig</code></pre>
<p>Copy the modified config back into the kernel tree:</p>
<pre class="wiki"><code>cp .config ../../../config-pvops</code></pre>
<h4 id="Patchingthecode">Patching the code</h4>
<p>TODO: describe the workflow for patching the code, below are some random notes, not working well</p>
<pre class="wiki"><code>ln -s ../../patches.xen
export QUILT_PATCHES=patches.xen
export QUILT_REFRESH_ARGS=&quot;-p ab --no-timestamps --no-index&quot;
export QUILT_SERIES=../../series-pvops.conf

quilt new patches.xen/pvops-3.4-0101-usb-xen-pvusb-driver-bugfix.patch
quilt add drivers/usb/host/Kconfig drivers/usb/host/Makefile \
        drivers/usb/host/xen-usbback/* drivers/usb/host/xen-usbfront.c \
        include/xen/interface/io/usbif.h

*edit something*

quilt refresh
cd ../..
vi series-pvops.conf</code></pre>
<h4 id="BuildingRPMS">Building RPMS</h4>
<p>TODO: Is this step generic for all subsystems?</p>
<p>Now it is a good moment to make sure you have changed kernel release name in rel-pvops file. For example, if you change it to '1debug201211116c' the resulting RPMs will be named 'kernel-3.4.18-1debug20121116c.pvops.qubes.x86_64.rpm'. This will help distinguish between different versions of the same package.</p>
<p>You might want to take a moment here to review (git diff, git status), commit your changes locally.</p>
<p>To actually build RPMS, in qubes-src/kernel:</p>
<pre class="wiki"><code>make rpms</code></pre>
<p>RPMS will appear in qubes-src/kernel/rpm/x86_64:</p>
<pre class="wiki"><code>-rw-rw-r-- 1 user user 42996126 Nov 17 04:08 kernel-3.4.18-1debug20121116c.pvops.qubes.x86_64.rpm
-rw-rw-r-- 1 user user 43001450 Nov 17 05:36 kernel-3.4.18-1debug20121117a.pvops.qubes.x86_64.rpm
-rw-rw-r-- 1 user user  8940138 Nov 17 04:08 kernel-devel-3.4.18-1debug20121116c.pvops.qubes.x86_64.rpm
-rw-rw-r-- 1 user user  8937818 Nov 17 05:36 kernel-devel-3.4.18-1debug20121117a.pvops.qubes.x86_64.rpm
-rw-rw-r-- 1 user user 54490741 Nov 17 04:08 kernel-qubes-vm-3.4.18-1debug20121116c.pvops.qubes.x86_64.rpm
-rw-rw-r-- 1 user user 54502117 Nov 17 05:37 kernel-qubes-vm-3.4.18-1debug20121117a.pvops.qubes.x86_64.rpm</code></pre>
<h3 id="UsefulQubesBuildercommands">Useful <a href="/wiki/wiki/QubesBuilder">QubesBuilder</a> commands</h3>
<ol>
<li><em>make check</em> - will check if all the code was commited into repository and if all repository are tagged with signed tag.</li>
<li><em>make show-vtags</em> - show version of each component (based on git tags) - mostly useful just before building ISO. <strong>Note:</strong> this will not show version for components containing changes since last version tag</li>
<li><em>make push</em> - push change from <strong>all</strong> repositories to git server. You must set proper remotes (see above) for all repositories first.</li>
<li><em>make prepare-merge</em> - fetch changes from remote repositories (can be specified on commandline via GIT_SUBDIR or GIT_REMOTE vars), (optionally) verify tags and show the changes. This do not merge the changes - there are left for review as FETCH_HEAD ref. You can merge them using &quot;git merge FETCH_HEAD&quot; (in each repo directory).</li>
</ol>
<h2 id="CopyingCodetodom0">Copying Code to dom0</h2>
<p>When developing it is convenient to be able to rapidly test changes. Assuming you're developing Qubes on Qubes, you should be working in a special VM for Qubes and occasionally you will want to transfer code or rpms back to dom0 for testing.</p>
<p>Here are some handy scripts Marek has shared to facilitate this.</p>
<h3 id="Syncingdom0files">Syncing dom0 files</h3>
<p>TODO: edit this script to be more generic</p>
<pre class="wiki"><code>#!/bin/sh

set -x
set -e

QUBES_PY_DIR=/usr/lib64/python2.6/site-packages/qubes
QUBES_PY=$QUBES_PY_DIR/qubes.py
QUBESUTILS_PY=$QUBES_PY_DIR/qubesutils.py

qvm-run -p qubes-devel &#39;cd qubes-builder/qubes-src/core/dom0; tar c qmemman/qmemman*.py qvm-core/*.py qvm-tools/* misc/vm-template-hvm.conf misc/qubes-start.desktop ../misc/block-snapshot aux-tools ../qrexec&#39; |tar xv
cp $QUBES_PY qubes.py.bak$$
cp $QUBESUTILS_PY qubesutils.py.bak$$
cp /etc/xen/scripts/block-snapshot block-snapshot.bak$$
sudo cp qvm-core/qubes.py $QUBES_PY
sudo cp qvm-core/qubesutils.py $QUBESUTILS_PY
sudo cp qvm-core/guihelpers.py $QUBES_PY_DIR/
sudo cp qmemman/qmemman*.py $QUBES_PY_DIR/
sudo cp misc/vm-template-hvm.conf /usr/share/qubes/
sudo cp misc/qubes-start.desktop /usr/share/qubes/
sudo cp misc/block-snapshot /etc/xen/scripts/
sudo cp aux-tools/qubes-dom0-updates.cron /etc/cron.daily/I hope to </code></pre>
<h3 id="Applyqvm-tools">Apply qvm-tools</h3>
<p>TODO: make it more generic</p>
<pre class="wiki"><code>#!/bin/sh

BAK=qvm-tools.bak$$
mkdir -p $BAK
cp -a /usr/bin/qvm-* /usr/bin/qubes-* $BAK/
sudo cp qvm-tools/qvm-* qvm-tools/qubes-* /usr/bin/</code></pre>
<h3 id="Copyfromdom0toanappvm">Copy from dom0 to an appvm</h3>
<pre class="wiki"><code>#/bin/sh
#
# usage ./cp-domain &lt;vm_name&gt; &lt;file_to_copy&gt;
#
domain=$1
file=$2
fname=`basename $file`

qvm-run $domain &#39;mkdir /home/user/incoming/dom0 -p&#39;
cat $file| qvm-run --pass-io $domain &quot;cat &gt; /home/user/incoming/dom0/$fname&quot;</code></pre>
