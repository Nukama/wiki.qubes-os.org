<h1 id="UpgradeofFedoratemplate">Upgrade of Fedora template</h1>
<p>This instruction in simplified version of <a href="https://fedoraproject.org/wiki/Upgrading_Fedora_using_yum">â€‹official Fedora instruction</a>. Note that only &quot;yum&quot; method will work in Qubes template VM (if you are curious why: mostly because template VM does not have own bootloader).</p>
<h2 id="UpgradingFedora18toFedora20">Upgrading Fedora 18 to Fedora 20</h2>
<p>Commands to run in dom0 console (you can do the same from Qubes Manager):</p>
<pre class="wiki"><code>qvm-clone fedora-18-x64 fedora-20-x64
qvm-run -a fedora-20-x64</code></pre>
<p>Commands to run in new fedora-20-x64 template:</p>
<pre class="wiki"><code>sudo yum --releasever=20 distro-sync
poweroff</code></pre>
<p>If you have installed a lot of software in your template, it may happen that you don't have enough disk space for upgrade. Yum will tell you this just after confirming the operation (before it change anything to your system). In that case you need to provide some &quot;external&quot; place for yum cache (uses about 2GB during upgrade). For example attach virtual disk stored in some file. Prepare the file in dom0:</p>
<pre class="wiki"><code>truncate -s 5GB /var/tmp/template-upgrade-cache.img
qvm-block -A fedora-20-x64 dom0:/var/tmp/template-upgrade-cache.img</code></pre>
<p>Then use it in template:</p>
<pre class="wiki"><code>sudo mkfs.ext4 /dev/xvdi
sudo mount /dev/xvdi /mnt/removable
sudo yum --releasever=20 --setopt=cachedir=/mnt/removable distro-sync</code></pre>
<p>After upgrade is finished, you can remove /var/tmp/template-upgrade-cache.img file.</p>
<h1 id="Compactingtemplatesroot.img">Compacting templates root.img</h1>
<p>fstrim, nor &quot;discard&quot; mount option do not work on template root fs, so when some file is removed in the template, space isn't freed in dom0. This means that template will use about twice a space that is really need after upgrade.</p>
<p>You can compact root.img in the &quot;old way&quot;: Start the template, fill all the free space with zeros, for example with:</p>
<pre class="wiki"><code>dd if=/dev/zero of=/var/tmp/zero
(wait for &quot;No space left on device&quot; error)
rm -f /var/tmp/zero</code></pre>
<p>Then shutdown template and all VMs based on it. Go into template directory in dom0 (/var/lib/qubes/vm-templates/fedora-20-x64 or so) and issue:</p>
<pre class="wiki"><code>cp --sparse=always root.img root.img.new
mv root.img.new root.img</code></pre>
<p>Done.</p>
