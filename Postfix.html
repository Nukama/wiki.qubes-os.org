<h1 id="Postfix">Postfix</h1>
<p>Postfix is full featured MTA (Message Transfer Agent). Here we will configure it in smarthost mode as part of common <a href="/wiki/wiki/Mutt">Mutt</a>+Postfix+<a href="/wiki/wiki/Fetchmail">Fetchmail</a> stack.</p>
<h2 id="Installation">Installation</h2>
<p><code>yum install postfix procmail make</code></p>
<p>Procmail is not strictly neccessary, but is useful to sort your incoming mail, for example to put each mailing list in its own directory. Make is also not neccessary, but is used to keep Postfix lookup tables. You should also check <code>alternatives</code> command, to see if it is the default <code>mta</code>. It probably is not. You may need to <code>yum remove ssmtp</code> or something.</p>
<h2 id="Configuration">Configuration</h2>
<p>In TemplateVM open <code>/etc/aliases</code> and add line:</p>
<pre class="wiki"><code>root: user</code></pre>
<p>and run <code>newaliases</code>.</p>
<p>This is the only thing to do in TemplateVM, as MTA configuration is AppVM specific, so we will keep it in <code>/usr/local</code> (ie. <code>/rw/usrlocal</code>) in each AppVM.</p>
<p>Now shutdown TemplateVM, start AppVM. Create directory <code>/usr/local/etc/postfix</code> and copy <code>/etc/postfix/master.cf</code> there.</p>
<h3 id="Makefile">Makefile</h3>
<p>Postfix keeps its lookup tables in bdb hash databases. They need to be compiled from source files. Postfix admins like to keep track of them by means of <code>/usr/local/etc/postfix/Makefile</code>:</p>
<pre class="wiki"><code>all: $(addsuffix .db,$(shell sed -n -e &#39;/^[^#].*hash:\/etc\/postfix/s:.*/::p&#39; main.cf))
    newaliases
clean:
    $(RM) *.db
.PHONY: all clean

%.db: %
    /usr/sbin/postmap hash:$&lt;
</code></pre>
<h3 id="Postfixmainconfiguration">Postfix main configuration</h3>
<p><code>/usr/local/etc/postfix/main.cf</code> (<code>/etc/postfix</code> is intentional, don't correct it):</p>
<pre class="wiki"><code>mydestination = $myhostname, $myhostname.$mydomain, $myhostname.localdomain, localhost, localhost.$mydomain, localhost.localdomain, $mydomain, localdomain
mynetworks_style = host

inet_protocols = ipv4

smtp_generic_maps = hash:/etc/postfix/generic
local_header_rewrite_clients =

smtp_sender_dependent_authentication = yes
sender_dependent_relayhost_maps = hash:/etc/postfix/sender_relay
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/saslpass
smtp_sasl_security_options =
smtp_tls_security_level = encrypt
smtp_sasl_mechanism_filter = plain, login
smtpd_relay_restrictions = permit_mynetworks,permit_sasl_authenticated,defer_unauth_destination
smtpd_sender_restrictions = check_sender_access hash:/etc/postfix/sender_access

home_mailbox = .maildir/
setgid_group = postdrop
mail_owner = postfix

html_directory = no
manpage_directory = /usr/share/man
queue_directory = /var/spool/postfix
readme_directory = no

mailbox_command = /usr/bin/procmail
sendmail_path = /usr/sbin/sendmail
newaliases_path = /usr/bin/newaliases
mailq_path = /usr/bin/mailq
alias_maps = hash:/etc/aliases</code></pre>
<h3 id="Lookuptables">Lookup tables</h3>
<p><code>/usr/local/etc/postfix/generic</code> (put there your primary address):</p>
<pre class="wiki"><code>@localhost your.mail@example.com</code></pre>
<p><code>/usr/local/etc/postfix/sender_relay</code>. This is important file. Put there all your SMTP servers. Pay attention to port (smtp/submission). Square brackets have their special meaning, they are almost certainly needed. For more info consult Postfix manual.</p>
<pre class="wiki"><code>your.mail@exmaple.com         [mail.example.com]:submission
your.other@mail.com         [smtp.mail.com]:smtp</code></pre>
<p><code>/usr/local/etc/postfix/saslpass</code>. Here you put passwords to abovementioned servers. It depends on provider if you need to put whole email as username or just the part before <code>@</code>.</p>
<pre class="wiki"><code>[mail.example.com]:submission     your.mail:y0urP4ssw0rd
[smtp.mail.com]:smtp            your.other@mail.com:supers3cret</code></pre>
<p><code>/usr/local/etc/postfix/sender_access</code>. I use it to nullroute known spam domains. If you do not need it, comment respective line in <code>main.cf</code>.</p>
<pre class="wiki"><code>spamdomain1.com       DISCARD
spamdomain2.com     DISCARD</code></pre>
<p>Now run <code>make</code> in <code>/usr/local/etc/postfix</code>. It will hopefully compile four abovementioned lookup tables (<code>generic.db</code>, <code>sender_relay.db</code>, <code>saslpass.db</code> and <code>sender_access</code>).</p>
<h3 id="procmail">procmail</h3>
<p>Don't start postfix or fetchmail yet, first create <code>/home/user/.procmailrc</code>:</p>
<pre class="wiki"><code>MAILDIR = &quot;${HOME}/.maildir&quot;
ORGMAIL = &quot;${MAILDIR}/&quot;
DEFAULT = &quot;${MAILDIR}/&quot;

:0
* ^List-Id:.*qubes-users\.googlegroups\.com
list/qubes-users/

:0
* ^List-Id:.*qubes-devel\.googlegroups\.com
list/qubes-devel/</code></pre>
<h2 id="Run">Run</h2>
<p>Open <code>/rw/config/rc.local</code> and add those two lines (before fetchmail lines, if you have them):</p>
<pre class="wiki"><code>#!/bin/sh

mount --bind /usr/local/etc/postfix /etc/postfix
systemctl --no-block start postfix</code></pre>
<p>Reboot your AppVM and you are done.</p>
