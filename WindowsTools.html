<h1 id="QubesToolsforWindows:advancedsettingsandtroubleshooting">Qubes Tools for Windows: advanced settings and troubleshooting</h1>
<h2 id="Installablecomponents">Installable components</h2>
<p>Qubes Tools for Windows (QTW for short) contain several components than can be enabled or disabled during installation:</p>
<ul>
<li>Xen GPL PV drivers (required): drivers for the hardware exposed by Xen.</li>
<li>Core Windows Agent: qrexec agent and services. Needed for proper integration with Qubes.</li>
<li>Move user profiles: User profiles directory (c:\Users) will be moved into the private disk backed by private.img. This disk will be initialized/formatted automatically if needed. This feature is useful for Windows-based HVM templates, so child AppVMs can have their separate user profiles.</li>
<li>GUI Windows Agent: video driver and gui agent that enable seamless showing of Windows applications on the secure Qubes desktop.</li>
<li>Disable UAC: disables User Account Control prompts. <em>Is this still needed/wanted? Gui agent can handle UAC prompts now.</em></li>
</ul>
<p>It's probably a good idea to install a VNC server in the VM before installing QTW. If something goes very wrong with the Qubes gui agent, a VNC server should still allow access to the OS.</p>
<h2 id="Configuration">Configuration</h2>
<p>Starting from version 2.2.* various aspects of Qubes Tools for Windows can be configured through registry. Main configuration key is located in <code>HKEY_LOCAL_MACHINE\SOFTWARE\Invisible Things Lab\Qubes Tools</code>. Configuration values set on this level are global to all QTW components. It's possible to override global values with component-specific keys, this is useful mainly for setting log verbosity for troubleshooting. Possible configuration values are:</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>Name</strong></th>
<th style="text-align: left;"><strong>Type</strong></th>
<th style="text-align: left;"><strong>Description</strong></th>
<th style="text-align: left;"><strong>Default value</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">LogDir</td>
<td style="text-align: left;">String</td>
<td style="text-align: left;">Directory where logs are created</td>
<td style="text-align: left;">c:\Program Files\Invisible Things Lab\Qubes OS Windows Tools\log</td>
</tr>
<tr class="even">
<td style="text-align: left;">LogLevel</td>
<td style="text-align: left;">DWORD</td>
<td style="text-align: left;">Log verbosity (see below)</td>
<td style="text-align: left;">2 (INFO)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">LogRetention</td>
<td style="text-align: left;">DWORD</td>
<td style="text-align: left;">Maximum age of log files (in seconds), older logs are automatically deleted</td>
<td style="text-align: left;">604800 (7 days)</td>
</tr>
</tbody>
</table>
<p>Possible log levels:</p>
<table>
<tbody>
<tr class="odd">
<td style="text-align: left;">0</td>
<td style="text-align: left;">Error</td>
<td style="text-align: left;">Serious errors that most likely cause irrecoverable failures</td>
</tr>
<tr class="even">
<td style="text-align: left;">1</td>
<td style="text-align: left;">Warning</td>
<td style="text-align: left;">Unexpected but non-fatal events</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2</td>
<td style="text-align: left;">Info</td>
<td style="text-align: left;">Useful information</td>
</tr>
<tr class="even">
<td style="text-align: left;">3</td>
<td style="text-align: left;">Debug</td>
<td style="text-align: left;">Internal state dumps for troubleshooting</td>
</tr>
<tr class="odd">
<td style="text-align: left;">4</td>
<td style="text-align: left;">Verbose</td>
<td style="text-align: left;">Trace most function calls</td>
</tr>
</tbody>
</table>
<p>Debug and Verbose levels can generate large volume of logs and are intended for development/troubleshooting only.</p>
<p>To override global settings for a specific component, create a new key under the root key mentioned above and name it as the executable name, without <code>.exe</code> extension. For example, to change qrexec-agent's log level to Debug, set it like this:</p>
<p><a href="/wiki/attachment/wiki/WindowsTools/qtw-log-level.png"><img src="/wiki/chrome/common/attachment.png" title="No image &quot;qtw-log-level.png&quot; attached to WindowsTools" alt="No image &quot;qtw-log-level.png&quot; attached to WindowsTools" /></a></p>
<p>Component-specific settings currently available:</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>Component</strong></th>
<th style="text-align: left;"><strong>Setting</strong></th>
<th style="text-align: left;"><strong>Type</strong></th>
<th style="text-align: left;"><strong>Description</strong></th>
<th style="text-align: left;"><strong>Default value</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">wga</td>
<td style="text-align: left;">UseDirtyBits</td>
<td style="text-align: left;">DWORD</td>
<td style="text-align: left;">Enable experimental feature of the gui agent/qvideo driver: use page table dirty bits to determine changed display regions. This can improve performance but may impact display responsiveness (some changes may not be detected resulting in &quot;stale&quot; image). Needs VM restart to apply change.</td>
<td style="text-align: left;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">wga</td>
<td style="text-align: left;">DisableCursor</td>
<td style="text-align: left;">DWORD</td>
<td style="text-align: left;">Disable cursor in the VM. Useful for integration with Qubes desktop so you don't see two cursors. Can be disabled if you plan to use the VM through a remote desktop connection of some sort. Needs gui agent restart to apply change (locking OS/logoff should be enough since wga is restarted on desktop change).</td>
<td style="text-align: left;">1</td>
</tr>
</tbody>
</table>
<h2 id="Troubleshooting">Troubleshooting</h2>
<p>If the VM is inaccessible (doesn't respond to qrexec commands, gui is not functioning), try to boot it in safe mode:</p>
<ul>
<li><code>qvm-start --debug vmname</code></li>
<li>mash F8 on the boot screen to enable boot options and select Safe Mode (optionally with networking)</li>
</ul>
<p>Safe Mode should at least give you access to logs (see above).</p>
<p><strong>Please include appropriate logs when reporting bugs/problems.</strong> Starting from version 2.4.2 logs contain QTW version, but if you're using an earlier version be sure to mention which one. If the OS crashes (BSOD) please include the BSOD code and parameters in your bug report. The BSOD screen should be visible if you run the VM in debug mode (<code>qvm-start --debug vmname</code>). If it's not visible or the VM reboots automatically, try to start Windows in safe mode (see above) and 1) disable automatic restart on BSOD (Control Panel - System - Advanced system settings - Advanced - Startup and recovery), 2) check the system event log for BSOD events.</p>
<p>If a specific component is malfunctioning, you can increase it's log verbosity as explained above to get more troubleshooting information. Below is a list of components:</p>
<table>
<tbody>
<tr class="odd">
<td style="text-align: left;">qrexec-agent</td>
<td style="text-align: left;">Responsible for most communication with Qubes (dom0 and other domains), secure clipboard, file copying, qrexec services.</td>
</tr>
<tr class="even">
<td style="text-align: left;">qrexec-client-vm</td>
<td style="text-align: left;">Used for communications by the qrexec protocol.</td>
</tr>
<tr class="odd">
<td style="text-align: left;">wga</td>
<td style="text-align: left;">Gui agent.</td>
</tr>
<tr class="even">
<td style="text-align: left;">QTWHelper</td>
<td style="text-align: left;">Service that monitors session/desktop changes (logon/logoff/locking/UAC...) and simulates SAS sequence (ctrl-alt-del).</td>
</tr>
<tr class="odd">
<td style="text-align: left;">prepare-volume</td>
<td style="text-align: left;">Utility that initializes and formats the disk backed by <code>private.img</code> file. It's registered to run on next system boot during QTW setup, if that feature is selected (it can't run <em>during</em> the setup because Xen block device drivers are not yet active). It in turn registers move-profiles (see below) to run at early boot.</td>
</tr>
<tr class="even">
<td style="text-align: left;">move-profiles</td>
<td style="text-align: left;">Utility that moves user profiles directory to the private disk. It's registered as an early boot native executable (similar to chkdsk) so it can run before any profile files are opened by some other process. Its log is in a fixed location: <code>c:\move-profiles.log</code> (it can't use our common logger library so none of the log settings apply).</td>
</tr>
</tbody>
</table>
<p>When we publish new QTW version (which is announced on <code>qubes-users</code> Google Group) it's usually pushed to the <code>current-testing</code> repository first. To use versions from current-testing, run this in dom0:</p>
<p><code>qubes-dom0-update --enablerepo=qubes-dom0-current-testing qubes-windows-tools</code></p>
<p>That command will download a new QTW .iso from the testing repository. It goes without saying that you should <strong>backup your VMs</strong> before installing anything from testing repos.</p>
