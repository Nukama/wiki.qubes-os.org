<h1 id="InstallingandusingWindows-basedAppVMs">Installing and using Windows-based AppVMs</h1>
<p>Qubes provides special support for running Windows-based AppVMs. This requires the user to install Windows 7 x64 in a Qubes VM and subsequently install Qubes Windows Support tools inside the VM. This page describes this process in detail.</p>
<p>Qubes support tools for Windows is a set of programs and drivers that provide integration of Windows AppVMs with the rest of the Qubes system. Currently the following features are available for Windows VMs after installation of those tools:</p>
<ul>
<li>Seamless GUI mode that integrates apps windows onto the common Qubes trusted desktop (available on Qubes R2 Beta 3 and later)</li>
<li>Support for <a href="/wiki/wiki/CopyPaste">secure clipboard copy/paste</a> between the Windows VM and other AppVMs</li>
<li>Support for <a href="/wiki/wiki/CopyingFiles">secure file exchange</a> between the Windows VM and other AppVMs</li>
<li>Support for qvm-run and generic qrexec for the Windows VM (e.g. ability to run custom service within/from the Windows VM)</li>
<li>Xen PV drivers for Windows that increase performance compared to qemu emulated devices</li>
</ul>
<p>Qubes Windows Support Tools are not open source and are distributed under a commercial license and their source code is not publicly available.</p>
<h2 id="InstallingWindowsOSinaQubesVM">Installing Windows OS in a Qubes VM</h2>
<p>Please refer to <a href="/wiki/wiki/HvmCreate">this page</a> for instructions on how to install Windows in a Qubes VM.</p>
<h2 id="InstallingQubessupporttoolsinWindows7VMs">Installing Qubes support tools in Windows 7 VMs</h2>
<p>To install the Qubes Windows support tools in a Windows VM one should start the VM passing the additional option <code>--install-windows-tools</code>:</p>
<pre class="wiki"><code>qvm-start lab-win7 --install-windows-tools</code></pre>
<p>Once the Windows VM boots, a CDROM should appear in the 'My Computer' menu (typically as <code>D:</code>) with a setup program in its main directory.</p>
<p>Before proceeding with the installation we need to disable Windows mechanism that allows only signed drivers to be installed, because currently (beta releases) the drivers we provide as part of the Windows Support Tools are not digitally signed with a publicly recognizable certificate. How to do that is explained in the <code>README</code> file also located on the installation CDROM. In the future this step will not be necessary anymore, because we will sign our drivers with a publicly verifiable certificate. However, it should be noted that even now, the fact that those drivers are not digitally signed, this doesn't affect security of the Windows VM in 'any' way. This is because the actual installation ISO (the <code>qubes-windows-tools-*.iso</code> file) is distributed as a signed RPM package and its signature is verified by the <code>qubes-dom0-update</code> utility once it's being installed in Dom0. The only downside of those drivers not being signed is the inconvenience to the user that he or she must disable the signature enforcement policy before installing the tools, and also to accept a few scary looking warning windows during the installation process, as shown below.</p>
<p><a href="/wiki/attachment/wiki/HvmCreate/r2b1-win7-installing-qubes-tools-5.png"><img src="/wiki/chrome/common/attachment.png" title="No image &quot;r2b1-win7-installing-qubes-tools-5.png&quot; attached to HvmCreate" alt="No image &quot;r2b1-win7-installing-qubes-tools-5.png&quot; attached to HvmCreate" /></a></p>
<p>After successful installation, the Windows VM must be shut down and started again.</p>
<p>Qubes (R2 Beta 3 and later releases) will automatically detect the tools has been installed in the VM and will set appropriate properties for the VM, such as <code>qrexec_installed</code>, <code>guiagent_installed</code>, and <code>default_user</code>. This can be verified (but is not required) using qvm-prefs command:</p>
<pre class="wiki"><code>qvm-prefs &lt;your-appvm-name&gt;</code></pre>
<h2 id="UsingWindowsAppVMsinseamlessmodeQubesR2Beta3andlater">Using Windows AppVMs in seamless mode (Qubes R2 Beta 3 and later)</h2>
<p>Once you start a Windows-based AppVM with Qubes Tools installed, you can easily start individual applications from the VM (note the <code>-a</code> switch used here, which will auto-start the VM if it is not running):</p>
<pre class="wiki"><code>qvm-run -a my-win7-appvm explorer.exe</code></pre>
<p><a href="/wiki/attachment/wiki/WindowsAppVms/windows-seamless-4.png"><img src="/wiki/chrome/common/attachment.png" title="No image &quot;windows-seamless-4.png&quot; attached to WindowsAppVms" alt="No image &quot;windows-seamless-4.png&quot; attached to WindowsAppVms" /></a> <a href="/wiki/attachment/wiki/WindowsAppVms/windows-seamless-1.png"><img src="/wiki/chrome/common/attachment.png" title="No image &quot;windows-seamless-1.png&quot; attached to WindowsAppVms" alt="No image &quot;windows-seamless-1.png&quot; attached to WindowsAppVms" /></a></p>
<p>Also, the inter-VM services work as usual -- e.g. to request opening a document or URL in the Windows AppVM from another VM:</p>
<pre class="wiki"><code>[user@work ~]$ qvm-open-in-vm work-win7 roadmap.pptx</code></pre>
<pre class="wiki"><code>[user@work ~]$ qvm-open-in-vm work-win7 http://www.invisiblethingslab.com</code></pre>
<p>... just like in case of Linux AppVMs. Of course all those operations are governed by central policy engine running in Dom0 -- if the policy</p>
<p>Inter-VM file copy and clipboard works for Windows AppVMs the same way as for Linux AppVM (except that we don't provide a command line wrapper, <code>qvm-copy-to-vm</code> in Windows VMs) -- to copy files from Windows AppVMs just right-click on the file in Explorer, and choose: Send To-&gt; Other AppVM.</p>
<p><a href="/wiki/attachment/wiki/WindowsAppVms/windows-seamless-7.png"><img src="/wiki/chrome/common/attachment.png" title="No image &quot;windows-seamless-7.png&quot; attached to WindowsAppVms" alt="No image &quot;windows-seamless-7.png&quot; attached to WindowsAppVms" /></a></p>
<h2 id="ForcingWindowsAppVMintofulldesktopmode">Forcing Windows AppVM into full desktop mode</h2>
<p>TODO</p>
<h2 id="Usingtemplate-basedWindowsAppVMsQubesR2Beta3andlater">Using template-based Windows AppVMs (Qubes R2 Beta 3 and later)</h2>
<p>Qubes allows HVM VMs to share a common root filesystem from a select Template VM, just like it is done for Linux AppVMs. This mode is not limited to Windows AppVMs, and can be used for any HVM (e.g. FreeBSD running in a HVM). In order to create a HVM TemplateVM one can use the following command:</p>
<pre class="wiki"><code>qvm-create --hvm-template win7-x64-template -l green</code></pre>
<p>... and install Windows OS (or other OS) into this template the same way as you would install it into a normal HVM -- please see <a href="/wiki/wiki/HvmCreate">this page</a> instructions. However, it would make lots of sense to store the <code>C:\Users</code> directory on the 2nd disk which is automatically exposed by Qubes to all HVMs. Please consult your OS documentation on how to move the user's directories to a 2nd disk -- there are at least three ways of how to achieve that on Windows OS:</p>
<ul>
<li>By choosing special options during installation</li>
<li>By creating links of C:\Users to the 2nd disk</li>
<li>By modifying registry entries which define where the user profiles are stored.</li>
</ul>
<p>Please note that the 2nd disk is not formatted and so this should be done within the OS. The screenshots below show how to do this on Windows 7:</p>
<p><a href="/wiki/attachment/wiki/WindowsAppVms/windows-private-disk-formatting-2.png"><img src="/wiki/chrome/common/attachment.png" title="No image &quot;windows-private-disk-formatting-2.png&quot; attached to WindowsAppVms" alt="No image &quot;windows-private-disk-formatting-2.png&quot; attached to WindowsAppVms" /></a> <a href="/wiki/attachment/wiki/WindowsAppVms/windows-private-disk-formatting-3.png"><img src="/wiki/chrome/common/attachment.png" title="No image &quot;windows-private-disk-formatting-3.png&quot; attached to WindowsAppVms" alt="No image &quot;windows-private-disk-formatting-3.png&quot; attached to WindowsAppVms" /></a></p>
<p>This 2nd disk is backed by the <code>private.img</code> file in the AppVMs' and is not reset upon AppVMs reboot, so the user's directories and profiles would survive the AppVMs reboot, unlike the &quot;root&quot; filesystem which will be reverted to the &quot;golden image&quot; from the Template VM automatically.</p>
<p>For this reason it also makes sense to disable Automatic Updates for all the Windows-based AppVMs -- of course this should be done in the Template VM, not in individual AppVMs, because the system-wide setting are stored in the root filesystem (which holds the system-wide registry hives).</p>
<p>Once the template has been created and installed it is easy to create AppVMs based on:</p>
<pre class="wiki"><code>qvm-create --hvm &lt;new windows appvm name&gt; --template &lt;name of template vm&gt; --label &lt;label color&gt;</code></pre>
