<h1 id="Templatebuilding">Template building</h1>
<p>The archlinux VM is now almost working as a NetVM. Based on qubes-builder code, you could find below how to build it and problem that could arise from template building to using archlinux as a netvm:</p>
<h2 id="Downloadqubes-buildergitcode">Download qubes-builder git code</h2>
<p>Prefer marmarek git repository as it is the most recent one</p>
<h2 id="Changeyourbuilder.conf">Change your builder.conf</h2>
<p>Change the following variables GIT_SUBDIR=marmarek DISTS_VM=archlinux</p>
<h2 id="Getallrequiredsources">Get all required sources</h2>
<pre class="wiki"><code>make get-sources</code></pre>
<p>Note that make get-sources sometimes fails because it didn't download packages that are not used by archlinux such as xfce or kde packages.</p>
<p>You can ignore the repositories that are failing by adding the following line to your builder.conf:</p>
<pre class="wiki"><code>COMPONENTS:=$(filter-out desktop-linux-kde desktop-linux-xfce,$(COMPONENTS))</code></pre>
<p>Just don't forget that you need to comment this line again if you want to build the whole Qubes-OS install CD.</p>
<h2 id="Makeallrequiredqubescomponents">Make all required qubes components</h2>
<p>The first use of the builder can take several hours depending on your bandwidth as it will install an archlinux chroot:</p>
<pre class="wiki"><code>make vmm-xen-vm
make core-vchan-xen-vm
make linux-utils-vm
make core-agent-linux-vm
make gui-common-vm
make gui-agent-linux-vm</code></pre>
<h2 id="Nowbuildthetemplateitself">Now build the template itself</h2>
<p>This can take again several hours, especially the first time you built and archlinux template:</p>
<pre class="wiki"><code>make linux-template-builder</code></pre>
<h2 id="Retrieveyourtemplate">Retrieve your template</h2>
<p>You can now find your template in qubes-src/linux-template-builder/rpm/noarch. Install it in dom0 (just take care as it will replace your current archlinux-x64 template)</p>
<hr />
<h1 id="KnownproblemsduringbuildingorwhenrunningtheVM">Known problems during building or when running the VM</h1>
<h2 id="Cantopenfilearchlinux-2013.02.01-dual.iso">Can't open file archlinux-2013.02.01-dual.iso</h2>
<p>Archlinux ISO files are sometimes removed from mirrors. Check the last version available on the archlinux mirror (eg: <a href="http://mir.archlinux.fr/iso/">​http://mir.archlinux.fr/iso/</a>), and update qubes-src/linux-template-builder/scripts_archlinux/00_prepare.sh accordingly:</p>
<pre class="wiki"><code>ISO_VERSION=2013.06.01</code></pre>
<p>You will also need to download the signature matching this ISO version inside qubes-src/linux-template-builder/scripts_archlinux/:</p>
<pre class="wiki"><code>wget http://mir.archlinux.fr/iso/2013.06.01/archlinux-2013.06.01-dual.iso.sig</code></pre>
<h2 id="Thenm-appletnetworkmanagericonfailstostartwhenarchlinuxisdefinedasatemplate-vm:">The nm-applet (network manager icon) fails to start when archlinux is defined as a template-vm:</h2>
<p>In fact /etc/dbus-1/system.d/org.freedesktop.<a href="/wiki/wiki/NetworkManager">NetworkManager?</a>.conf does not allow a standard user to run network manager clients. To allow this, one need to change inside &lt;policy context=&quot;default&quot;&gt;:</p>
<pre class="wiki"><code>&lt;deny send_destination=&quot;org.freedesktop.NetworkManager&quot;/&gt;</code></pre>
<p>to</p>
<pre class="wiki"><code>&lt;allow send_destination=&quot;org.freedesktop.NetworkManager&quot;/&gt;</code></pre>
<h2 id="DispVMYumproxyandmostQubesaddonsthunderbird...havenotbeentestedatall.">DispVM, Yum proxy and most Qubes addons (thunderbird ...) have not been tested at all.</h2>
<h2 id="ThesounddoesnotworkinAppVMsandtherearemessagesrelatedtopulsesegfaultinglibcwhenrunningdmesgFIXED">The sound does not work in AppVMs and there are messages related to pulse segfault in glibc when running dmesg (FIXED)</h2>
<p>This is apparently a bug in Archlinux between glibc and pulseaudio package 4.0-6. The packages pulseaudio-4.0-2 and libpulse-4.0-2 are known to work and can be downloaded and reinstalled manually.</p>
<h2 id="Errorwhenbuildingthegui-agent-linuxwithpulsecoreerror">Error when building the gui-agent-linux with pulsecore error</h2>
<pre class="wiki"><code>module-vchan-sink.c:62:34: fatal error: pulsecore/core-error.h: No such file or directory
 #include &lt;pulsecore/core-error.h&gt;</code></pre>
<p>This error is because Archlinux update package too quickly. Probably, a new version of pulseaudio has been released, but the qubes team has not imported the new development headers yet.</p>
<p>You can create fake new headers just by copying the old headers:</p>
<pre class="wiki"><code>cd qubes-builder/qubes-src/gui-agent-linux/pulse
ls
cp -r pulsecore-#lastversion pulsecore-#archlinuxversion</code></pre>
<p>You can check the current archlinux pulseaudio version like this:</p>
<pre class="wiki"><code>sudo chroot chroot-archlinux/ pacman -Qi pulseaudio</code></pre>
<h2 id="chroot-archlinuxdevptshasnotbeenunmounted">chroot-archlinux/dev/pts has not been unmounted</h2>
<p>This is a known problem when there are errors during building. Check what is mounted using the command mount (with no parameters). Just unmount what you can (or reboot your vm if you are too lazy :) )</p>
<h1 id="KnownproblemsinQubesR2-B2">Known problems in Qubes R2-B2</h1>
<h2 id="xen-vmm-vmfailtobuildwithaPARSETUPLErelatederrorFIXED:">xen-vmm-vm fail to build with a PARSETUPLE related error (FIXED):</h2>
<p>Commenting out &quot;#define HAVE_ATTRIBUTE_FORMAT_PARSETUPLE&quot; from chroot_archlinux/usr/include/python2.7/pyconfig.h fixes the problem, but it isn't the right solution [1]...</p>
<p>A better fix is planned for the next python release (the bug is considered release blocking), and will be updated in archlinux chroot as soon as available.</p>
<p>[1] <a href="http://bugs.python.org/issue17547">​http://bugs.python.org/issue17547</a></p>
<h2 id="Thebootprocessfailswithoutvisibleerrorsinthelogsbutspawnarecoveryshell">The boot process fails without visible errors in the logs, but spawn a recovery shell</h2>
<p>The problem is a new conflict between systemd and the old sysvinit style. To fix this, you can change the master xen template in dom0 to remove sysvinit remains: Edit <strong>INSIDE DOM0</strong> /usr/share/qubes/vm-template.conf, and change the variable 'extra' that contains the kernel variables: from:</p>
<pre class="wiki"><code>extra=&quot;ro nomodeset 3 console=hvc0 rd_NO_PLYMOUTH {kernelopts}&quot;</code></pre>
<p>to:</p>
<pre class="wiki"><code>extra=&quot;ro nomodeset console=hvc0 rd_NO_PLYMOUTH {kernelopts}&quot;</code></pre>
<h2 id="Qubes-OSisnowusingdifferentxenstorevariablenameswhichmakestoarchlinuxVMfailingtoboot">Qubes-OS is now using different xenstore variable names, which makes to archlinux VM failing to boot</h2>
<p>Apply the following fix in the template to revert the variable name to the old Qubes version.</p>
<p>You can edit the template the following way:</p>
<pre class="wiki"><code>sudo mkdir /mnt/vm
sudo mount /var/lib/qubes/vm-templates/archlinux-x64/root.img /mnt/vm
sudo chroot /mnt/vm</code></pre>
<p>Then apply the fix:</p>
<pre class="wiki"><code>sudo sed &#39;s:qubes-keyboard:qubes_keyboard:g&#39; -i /etc/X11/xinit/xinitrc.d/qubes-keymap.sh

sudo sed &#39;s:qubes-netvm-domid:qubes_netvm_domid:g&#39; -i /etc/NetworkManager/dispatcher.d/30-qubes-external-ip
sudo sed &#39;s:qubes-netvm-external-ip:qubes_netvm_external_ip:g&#39; -i /etc/NetworkManager/dispatcher.d/30-qubes-external-ip

sudo sed &#39;s:qubes-netvm-network:qubes_netvm_network:g&#39; -i /usr/lib/qubes/init/network-proxy-setup.sh
sudo sed &#39;s:qubes-netvm-gateway:qubes_netvm_gateway:g&#39; -i /usr/lib/qubes/init/network-proxy-setup.sh
sudo sed &#39;s:qubes-netvm-netmask:qubes_netvm_netmask:g&#39; -i /usr/lib/qubes/init/network-proxy-setup.sh
sudo sed &#39;s:qubes-netvm-secondary-dns:qubes_netvm_secondary_dns:g&#39; -i /usr/lib/qubes/init/network-proxy-setup.sh

sudo sed &#39;s:qubes-vm-type:qubes_vm_type:g&#39; -i /usr/lib/qubes/init/qubes-sysinit.sh

sudo sed &#39;s:qubes-ip:qubes_ip:g&#39; -i /usr/lib/qubes/setup-ip
sudo sed &#39;s:qubes-netmask:qubes_netmask:g&#39; -i /usr/lib/qubes/setup-ip
sudo sed &#39;s:qubes-gateway:qubes_gateway:g&#39; -i /usr/lib/qubes/setup-ip
sudo sed &#39;s:qubes-secondary-dns:qubes_secondary_dns:g&#39; -i /usr/lib/qubes/setup-ip
sudo sed &#39;s:qubes-netvm-network:qubes_netvm_network:g&#39; -i /usr/lib/qubes/setup-ip
sudo sed &#39;s:qubes-netvm-gateway:qubes_netvm_gateway:g&#39; -i /usr/lib/qubes/setup-ip
sudo sed &#39;s:qubes-netvm-netmask:qubes_netvm_netmask:g&#39; -i /usr/lib/qubes/setup-ip
sudo sed &#39;s:qubes-netvm-secondary-dns:qubes_netvm_secondary_dns:g&#39; -i /usr/lib/qubes/setup-ip

sudo sed &#39;s:qubes-iptables-domainrules:qubes_iptables_domainrules:g&#39; -i /usr/bin/qubes-firewall
sudo sed &#39;s:qubes-iptables-header:qubes_iptables_header:g&#39; -i /usr/bin/qubes-firewall
sudo sed &#39;s:qubes-iptables-error:qubes_iptables_error:g&#39; -i /usr/bin/qubes-firewall
sudo sed &#39;s:qubes-iptables:qubes_iptables:g&#39; -i /usr/bin/qubes-firewall

sudo sed &#39;s:qubes-netvm-domid:qubes_netvm_domid:g&#39; -i /usr/bin/qubes-netwatcher
sudo sed &#39;s:qubes-netvm-external-ip:qubes_netvm_external_ip:g&#39; -i /usr/bin/qubes-netwatcher
sudo sed &#39;s:qubes-vm-updateable:qubes_vm_updateable:g&#39; -i /usr/lib/qubes/qubes_trigger_sync_appmenus.sh

sudo sed &#39;s:qubes-vm-type:qubes_vm_type:g&#39; -i /usr/bin/qubes-session
sudo sed &#39;s:qubes-vm-updateable:qubes_vm_updateable:g&#39; -i /usr/bin/qubes-session</code></pre>
<p>Do not forgot to:</p>
<pre class="wiki"><code>umount /mnt/vm</code></pre>
<h2 id="Installingthetemplateindom0failsbecauseofamissingdependencyqubes-core-dom0-linux">Installing the template in dom0 fails because of a missing dependency (qubes-core-dom0-linux)</h2>
<p>Again you built a template based on a recent Qubes API which has not been released yet. So skip the dependency for now:</p>
<pre class="wiki"><code>sudo rpm -U --nodeps yourpackage.rpm</code></pre>
