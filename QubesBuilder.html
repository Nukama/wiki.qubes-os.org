<h1 id="BuildingQubesfromscratch">Building Qubes from scratch</h1>
<p>We have recently created a fully automated build system for Qubes, that downloads, builds and packages all the Qubes components, and finally should spit out a ready-to-use installation ISO.</p>
<p>In order to use it one should use an rpm-based distro, like Fedora :) and should ensure the following packages are installed:</p>
<ul>
<li>git</li>
<li>createrepo</li>
<li>rpm-build</li>
<li>make</li>
</ul>
<p>Unusually one can install those packages by just issuing:</p>
<pre class="wiki"><code>sudo yum install git createrepo rpm-build make wget</code></pre>
<p>The build system creates build environments in chroots and so no other packages are needed on the host. All files created by the build system are contained within the qubes-builder directory. The full build requires some 25GB of free space, so keep that in mind when deciding where to place this directory.</p>
<p>The build system is configured via builder.conf file -- one should copy the attached builder.conf.default, and modify it as needed, e.g.:</p>
<pre class="wiki"><code>cp builder.conf.default builder.conf 
# edit the builder.conf file and set the following variables: 
# (make sure to leave no spaces around &#39;=&#39; sign!) 
# NO_SIGN=&quot;1&quot;</code></pre>
<p>One additional useful requirement is that 'sudo root' work without any prompt, which is default on most distros (e.g. 'sudo bash' brings you the root shell without asking for any password). This is important as the builder needs to switch to root and then back to user several times during the build process.</p>
<p>Additionally, if building with signing enabled (so NO_SIGN is not set), one must adjust ~/.rpmmacro file so that it point to the GPG key used for package signing, e.g.:</p>
<pre class="wiki"><code>%_signature gpg
%_gpg_path /home/user/.gnupg
%_gpg_name AC1BF9B3  # &lt;-- Key ID used for signing</code></pre>
<p>It is also recommended to use an empty passphrase for the private key used for signing. Contrary to a popular belief, this doesn't affect your key or sources security -- if somebody compromised your system, then the game is over, whether you use additional passphrase for the key or not.</p>
<p>So, to build Qubes one would do:</p>
<pre class="wiki"><code># Import the Qubes master key 
gpg --recv-keys 0x36879494 

# Verify its fingerprint, set as &#39;trusted&#39;. 
# This is described here: 
# https://wiki.qubes-os.org/trac/wiki/VerifyingSignatures 

wget http://keys.qubes-os.org/keys/qubes-developers-keys.asc 
gpg --import qubes-developers-keys.asc 

git clone git://git.qubes-os.org/joanna/qubes-builder.git qubes-builder 
cd qubes-builder 

cp builder.conf.default builder.conf 
# edit the builder.conf file and set the following variables: 
# (make sure to leave no spaces around &#39;=&#39; sign!) 
# NO_SIGN=&quot;1&quot;

# And now to build all Qubes rpms (this will take a few hours): 

make qubes 

# ... and then to build the ISO 

make iso </code></pre>
<p>And this should produce a shiny new ISO.</p>
<p>You can also build selected component separately. Eg. to compile only gui virtualization agent/daemon:</p>
<pre class="wiki"><code>make gui</code></pre>
<p>Full list you can get from make help.</p>
<h2 id="Makingcustomizedbuild">Making customized build</h2>
<p>You can use above tool to build Qubes with some components modified. Described here procedure will build Qubes with:</p>
<ul>
<li>non-default kernel</li>
<li>newer Intel display driver</li>
</ul>
<p>The instruction:</p>
<ol>
<li>Download qubes-builder as described above</li>
<li>Edit builder.conf (still the same as above), some useful additions:
<ul>
<li><p>As time of writing this, the default is fc15, but latest supported is fc17, so switch to newer one</p>
<pre class="wiki"><code>DISTS_VM=&quot;fc17&quot;</code></pre></li>
<li>You can also set GIT_SUBDIR=&quot;marmarek&quot; to use my repo instead of &quot;mainstream&quot; - it contains newer (but less tested) versions</li>
</ul></li>
</ol>
<ol start="3">
<li><p>Download unmodified sources</p>
<pre class="wiki"><code>make get-sources</code></pre></li>
</ol>
<ol start="4">
<li>Make your modifications here</li>
</ol>
<ul>
<li><p>The kernel</p>
<pre class="wiki"><code>cd qubes-src/kernel
git fetch git://git.qubes-os.org/marmarek/kernel.git devel-3.4:devel-3.4
git checkout devel-3.4
# need to download sources again, as the first time the default (older) kernel source was downloaded
# note that this is run from kernel subdir, not main qubes-builder directory
make BUILD_FLAVOR=pvops get-sources

cd ../../</code></pre></li>
</ul>
<ul>
<li><p>Xorg driver</p>
<pre class="wiki"><code>cd qubes-src/dom0-updates
rm xorg-x11-driver-intel*fc15.src.rpm
yumdownloader --releasever=17 --source xorg-x11-driver-intel

cd ../../</code></pre></li>
</ul>
<blockquote>
<p>If you want to install any other package in newer version than in fc13 (on which dom0 is based), you can place it here. Remember to update also Makefile to include its build and add its build requires to <em>build-pkgs-dom0-updates.list</em> in qubes-builder dir.</p>
</blockquote>
<ol start="5">
<li><p>Build the Qubes<br /> <code>make qubes</code> actually is just meta target which build all required components in correct order</p>
<pre class="wiki"><code>grep ^qubes: Makefile
qubes: get-sources xen core kernel gui addons docs template kde-dom0 installer qubes-manager dom0-updates sign-all</code></pre></li>
</ol>
<blockquote>
<p><code>get-sources</code> is already done, so continue with the next one. You can skip <code>sign-all</code> if you've disabled signing</p>
<pre class="wiki"><code>make xen core kernel gui addons docs template kde-dom0 installer qubes-manager dom0-updates</code></pre>
</blockquote>
<ol start="6">
<li><p>build iso installation image</p>
<pre class="wiki"><code>make iso</code></pre></li>
</ol>
